#!/bin/sh

# shellcheck disable=SC2154
trap 'ret=$?; test $ret -ne 0 && printf "failed\n\n" >&2; exit $ret' EXIT

set -e

HOMEBREW_PREFIX="/usr/local"

if [ -d "$HOMEBREW_PREFIX" ]; then
  if ! [ -r "$HOMEBREW_PREFIX" ]; then
    sudo chown -R "$LOGNAME:admin" /usr/local
  fi
else
  sudo mkdir "$HOMEBREW_PREFIX"
  sudo chflags norestricted "$HOMEBREW_PREFIX"
  sudo chown -R "$LOGNAME:admin" "$HOMEBREW_PREFIX"
fi

if ! command -v brew >/dev/null; then
  echo "Installing Homebrew ..."
    /bin/bash -c \
    "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

    export PATH="/usr/local/bin:$PATH"
fi

if brew list | grep -Fq brew-cask; then
  echo "Uninstalling old Homebrew-Cask ..."
  brew uninstall --force brew-cask
fi

echo "Updating Homebrew formulae ..."
brew update --force # https://github.com/Homebrew/brew/issues/1151
brew bundle --file=- <<EOF

tap "dteoh/sqa"
tap "koekeishiya/formulae"
tap "warrensbox/homebrew-tap"

brew "awscli"
brew "ansible"
brew "ansiweather"
brew "bash"
brew "bash-completion"
brew "coreutils"
brew "fzf"
brew "git"
brew "go"
brew "helm"
brew "htop"
brew "jq"
brew "kind"
brew "k9s"
brew "kubernetes-cli"
brew "minikube"
brew "neovim"
brew "nmap"
brew "node@16"
brew "pgcli"
brew "pipenv"
brew "pyenv"
brew "python@3.9"
brew "ripgrep"
brew "shellcheck"
brew "skhd"
brew "telnet"
brew "terraform"
brew "tldr"
brew "vault"
brew "watch"
brew "wget"
brew "python"
brew "thefuck"
brew "tmux"
brew "unison"
brew "vim"
brew "tfswitch"
brew "wget"
brew "yabai"
brew "yq"

# casks
cask "alfred"
cask "brave-browser"
cask "daisydisk"
cask "docker"
cask "iterm2"
cask "keepassxc"
cask "lastpass"
cask "raycast"
cask "slack"
cask "slowquitapps"
cask "spotify"
cask "telegram"
cask "utm"
cask "whatsapp"
EOF

if [ -f "$HOME/.laptop.local" ]; then
  echo "Running your customizations from ~/.laptop.local ..."
  # shellcheck disable=SC1090
  . "$HOME/.laptop.local"
fi
